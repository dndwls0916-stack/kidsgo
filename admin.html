<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‚¤ì¦ˆê³  ê´€ë¦¬ì</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        :root {
            --primary: #FF6B9D; --primary-dark: #E85588; --primary-light: #FFD4E3;
            --secondary: #4ECDC4; --secondary-dark: #3BB5AD;
            --bg: #FFF8F0; --card: #FFFFFF; --text: #2D3436; --text-light: #636E72;
            --border: #E8E8E8; --success: #00b894; --warning: #fdcb6e; --danger: #e17055;
            --font: 'Noto Sans KR', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; }

        /* ===== ë¡œê·¸ì¸ í™”ë©´ ===== */
        .login-wrap {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #FF6B9D 0%, #4ECDC4 100%);
        }
        .login-box {
            background: white; border-radius: 24px; padding: 48px 40px;
            width: 100%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .login-logo {
            text-align: center; margin-bottom: 32px;
        }
        .login-logo i { font-size: 2.5rem; color: var(--primary); }
        .login-logo h1 { font-size: 1.4rem; font-weight: 800; margin-top: 8px; }
        .login-logo p { font-size: 0.82rem; color: var(--text-light); margin-top: 4px; }
        .login-field { margin-bottom: 16px; }
        .login-field label { display: block; font-size: 0.82rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
        .login-field input {
            width: 100%; padding: 12px 16px; border: 1.5px solid var(--border);
            border-radius: 10px; font-family: var(--font); font-size: 0.9rem;
            transition: border-color 0.2s; outline: none;
        }
        .login-field input:focus { border-color: var(--primary); }
        .login-btn {
            width: 100%; padding: 14px; background: var(--primary); color: white;
            border: none; border-radius: 10px; font-family: var(--font);
            font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s;
            margin-top: 8px;
        }
        .login-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .login-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .login-error {
            background: #fff5f5; color: var(--danger); border: 1px solid #fad7d7;
            border-radius: 8px; padding: 10px 14px; font-size: 0.82rem; margin-top: 12px;
            display: none;
        }

        /* ===== ë©”ì¸ ë ˆì´ì•„ì›ƒ ===== */
        .admin-wrap { display: none; }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 16px 24px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header h1 { font-size: 1.1rem; font-weight: 700; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .header-user { font-size: 0.82rem; opacity: 0.9; }
        .logout-btn {
            background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4);
            border-radius: 8px; padding: 6px 14px; font-size: 0.8rem; font-weight: 600;
            cursor: pointer; font-family: var(--font); transition: all 0.2s;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.35); }
        .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }

        /* ===== Stats ===== */
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--card); border-radius: 12px; padding: 16px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .stat-card .num { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-card .label { font-size: 0.75rem; color: var(--text-light); margin-top: 4px; }

        /* ===== íƒ­ ===== */
        .tab-nav { display: flex; gap: 4px; margin-bottom: 24px; }
        .tab-btn {
            flex: 1; padding: 12px 16px; border: none; border-radius: 10px;
            font-family: var(--font); font-size: 0.85rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s; background: #f1f2f6; color: var(--text-light);
        }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-btn .badge {
            display: inline-flex; align-items: center; justify-content: center;
            background: white; color: var(--primary); border-radius: 50%;
            width: 20px; height: 20px; font-size: 0.7rem; font-weight: 700; margin-left: 6px;
        }
        .tab-btn.active .badge { background: rgba(255,255,255,0.3); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ===== Section ===== */
        .section { background: var(--card); border-radius: 16px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 24px; }
        .section-title { font-size: 1rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .section-title i { color: var(--primary); }

        /* ===== ìˆ˜ì •ìš”ì²­ ì¹´ë“œ ===== */
        .filter-tabs { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
        .filter-tab {
            padding: 6px 16px; border-radius: 20px; border: 1.5px solid var(--border);
            background: white; font-family: var(--font); font-size: 0.8rem;
            cursor: pointer; transition: all 0.2s; font-weight: 500;
        }
        .filter-tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        .request-list { display: flex; flex-direction: column; gap: 12px; }
        .request-card {
            background: var(--card); border-radius: 14px; padding: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06); border-left: 4px solid var(--warning);
        }
        .request-card.approved { border-left-color: var(--success); opacity: 0.75; }
        .request-card.rejected { border-left-color: var(--danger); opacity: 0.75; }
        .request-card.manual { border-left-color: #a29bfe; }
        .request-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; gap: 4px; }
        .request-store { font-size: 1rem; font-weight: 700; }
        .request-date { font-size: 0.75rem; color: var(--text-light); }
        .request-field {
            display: inline-block; background: var(--primary-light); color: var(--primary-dark);
            padding: 2px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-bottom: 10px;
        }
        .request-field.manual-tag { background: #e8e5ff; color: #6c5ce7; }
        .request-values { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; margin-bottom: 10px; }
        .val-box { padding: 8px 12px; border-radius: 8px; font-size: 0.82rem; word-break: break-all; }
        .val-old { background: #fff5f5; color: #c0392b; border: 1px solid #fad7d7; text-decoration: line-through; }
        .val-new { background: #f0fff4; color: #00b894; border: 1px solid #b2f5c8; font-weight: 600; }
        .val-arrow { text-align: center; font-size: 1.2rem; color: var(--text-light); }
        .request-reason { font-size: 0.78rem; color: var(--text-light); margin-bottom: 10px; font-style: italic; }
        .request-actions { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
        .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d1e7dd; color: #0a3622; }
        .status-rejected { background: #f8d7da; color: #58151c; }

        /* ===== ì§ì ‘ í¸ì§‘ í¼ (ìˆ˜ë™ í•­ëª©ìš©) ===== */
        .manual-edit-form {
            background: #f8f6ff; border: 1.5px solid #a29bfe; border-radius: 10px;
            padding: 14px; margin-top: 10px; display: none;
        }
        .manual-edit-form.open { display: block; }
        .manual-edit-form label { font-size: 0.78rem; font-weight: 600; color: #6c5ce7; margin-bottom: 6px; display: block; }
        .manual-edit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; margin-bottom: 10px; }
        .manual-edit-grid .edit-field label { font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px; display: block; }
        .manual-edit-grid .edit-field input,
        .manual-edit-grid .edit-field select {
            width: 100%; padding: 8px 10px; border: 1.5px solid var(--border);
            border-radius: 8px; font-family: var(--font); font-size: 0.82rem; background: white;
        }
        .manual-save-btn {
            background: #6c5ce7; color: white; border: none; border-radius: 8px;
            padding: 8px 16px; font-family: var(--font); font-size: 0.82rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .manual-save-btn:hover { background: #5a4fcf; }

        /* ===== Buttons ===== */
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: 10px; border: none; font-family: var(--font); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: var(--secondary-dark); }
        .btn-outline { background: white; color: var(--primary); border: 1.5px solid var(--primary); }
        .btn-outline:hover { background: var(--primary-light); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #d63031; }
        .btn-purple { background: #6c5ce7; color: white; }
        .btn-purple:hover { background: #5a4fcf; }
        .btn-sm { padding: 7px 14px; font-size: 0.78rem; }

        /* ===== CSV ì—…ë¡œë“œ ===== */
        .steps { display: flex; gap: 4px; margin-bottom: 24px; }
        .step { flex: 1; text-align: center; padding: 10px 8px; background: #f1f2f6; border-radius: 8px; font-size: 0.78rem; font-weight: 500; color: var(--text-light); transition: all 0.3s; }
        .step.active { background: var(--primary); color: white; }
        .step.done { background: var(--success); color: white; }
        .step .step-num { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 50%; background: rgba(255,255,255,0.3); font-size: 0.7rem; font-weight: 700; margin-right: 4px; }
        .upload-zone { border: 2.5px dashed var(--border); border-radius: 16px; padding: 48px 24px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary); background: rgba(255,107,157,0.04); }
        .upload-zone i { font-size: 2.5rem; color: var(--primary-light); margin-bottom: 12px; display: block; }
        .upload-zone h3 { font-size: 1rem; margin-bottom: 8px; }
        .upload-zone p { font-size: 0.82rem; color: var(--text-light); }
        .upload-zone input { display: none; }
        .template-bar { display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #f0fffe 0%, #fff5f8 100%); border-radius: 12px; padding: 14px 18px; margin-bottom: 16px; border: 1px solid #e0f5f3; }
        .template-bar span { font-size: 0.82rem; color: var(--text-light); }
        .preview-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 12px; max-height: 400px; overflow-y: auto; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; min-width: 800px; }
        .preview-table th { background: #f8f9fa; position: sticky; top: 0; z-index: 2; padding: 10px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); white-space: nowrap; }
        .preview-table td { padding: 8px 12px; border-bottom: 1px solid #f1f2f6; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .preview-table tr:hover td { background: #fef9f0; }
        .preview-info { padding: 12px 16px; background: #f8f9fa; border-top: 1px solid var(--border); font-size: 0.78rem; color: var(--text-light); display: flex; justify-content: space-between; align-items: center; }
        .mapping-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
        .mapping-item { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: #f8f9fa; border-radius: 10px; font-size: 0.82rem; }
        .mapping-item .field-name { min-width: 120px; font-weight: 600; color: var(--primary-dark); }
        .mapping-item .field-required { color: var(--danger); font-size: 0.7rem; }
        .mapping-item select { flex: 1; padding: 6px 10px; border: 1.5px solid var(--border); border-radius: 8px; font-family: var(--font); font-size: 0.8rem; background: white; cursor: pointer; }
        .mapping-item select:focus { border-color: var(--primary); outline: none; }
        .mapping-item select.mapped { border-color: var(--success); background: #f0fff4; }
        .mapping-item select.unmapped { border-color: var(--warning); }
        .progress-bar { width: 100%; height: 12px; background: #f1f2f6; border-radius: 6px; overflow: hidden; margin: 12px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 6px; transition: width 0.3s; width: 0%; }
        .progress-text { font-size: 0.82rem; color: var(--text-light); text-align: center; }
        .result-log { background: #1e272e; color: #d2dae2; border-radius: 12px; padding: 16px; font-family: 'Courier New', monospace; font-size: 0.78rem; max-height: 300px; overflow-y: auto; line-height: 1.8; }
        .result-log .success { color: #00b894; }
        .result-log .error { color: #e17055; }
        .result-log .info { color: #74b9ff; }
        .result-log .warn { color: #fdcb6e; }
        .actions-bar { display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap; margin-top: 16px; }
        .alert { padding: 12px 16px; border-radius: 10px; font-size: 0.82rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .alert-info { background: #dff9fb; color: #0984e3; border: 1px solid #74b9ff; }
        .alert-warning { background: #ffeaa7; color: #6c5ce7; border: 1px solid #fdcb6e; }
        .existing-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .radio-group { display: flex; gap: 16px; }
        .radio-group label { display: flex; align-items: center; gap: 6px; font-size: 0.82rem; cursor: pointer; }
        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-light); }
        .empty-state i { font-size: 3rem; margin-bottom: 12px; opacity: 0.3; display: block; }

        @media (max-width: 768px) {
            .login-box { margin: 16px; padding: 32px 24px; }
            .steps { flex-wrap: wrap; }
            .step { flex: none; width: calc(50% - 2px); }
            .mapping-grid { grid-template-columns: 1fr; }
            .stats-bar { grid-template-columns: repeat(2, 1fr); }
            .tab-nav { flex-direction: column; }
            .request-values { grid-template-columns: 1fr; }
            .val-arrow { display: none; }
        }
    </style>
</head>
<body>

<!-- ===== ë¡œê·¸ì¸ í™”ë©´ ===== -->
<div class="login-wrap" id="loginWrap">
    <div class="login-box">
        <div class="login-logo">
            <i class="fas fa-baby"></i>
            <h1>í‚¤ì¦ˆê³  ê´€ë¦¬ì</h1>
            <p>ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
        </div>
        <div class="login-field">
            <label>ì´ë©”ì¼</label>
            <input type="email" id="loginEmail" placeholder="admin@kidsgo.kr" autocomplete="email">
        </div>
        <div class="login-field">
            <label>ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password"
                   onkeydown="if(event.key==='Enter') doLogin()">
        </div>
        <button class="login-btn" id="loginBtn" onclick="doLogin()">
            <i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸
        </button>
        <div class="login-error" id="loginError"></div>
    </div>
</div>

<!-- ===== ê´€ë¦¬ì ë©”ì¸ ===== -->
<div class="admin-wrap" id="adminWrap">
    <div class="header">
        <h1><i class="fas fa-shield-alt"></i> í‚¤ì¦ˆê³  ê´€ë¦¬ì</h1>
        <div class="header-right">
            <span class="header-user" id="headerUser"></span>
            <button class="logout-btn" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="container">
        <!-- Stats -->
        <div class="stats-bar">
            <div class="stat-card"><div class="num" id="statTotal">-</div><div class="label">í˜„ì¬ ë“±ë¡ ê°€ê²Œ</div></div>
            <div class="stat-card"><div class="num" id="statCat">-</div><div class="label">ì—…ì¢… ìˆ˜</div></div>
            <div class="stat-card"><div class="num" id="statRegion">-</div><div class="label">ì§€ì—­ ìˆ˜</div></div>
            <div class="stat-card"><div class="num" id="statAvgRating">-</div><div class="label">í‰ê·  í‰ì </div></div>
        </div>

        <!-- íƒ­ -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('requests')" id="tabRequests">
                <i class="fas fa-edit"></i> ì •ë³´ìˆ˜ì • ìš”ì²­ <span class="badge" id="pendingBadge">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('upload')" id="tabUpload">
                <i class="fas fa-upload"></i> CSV ë°ì´í„° ì—…ë¡œë“œ
            </button>
        </div>

        <!-- ìˆ˜ì •ìš”ì²­ íƒ­ -->
        <div class="tab-content active" id="tabContentRequests">
            <div class="section">
                <div class="section-title"><i class="fas fa-inbox"></i> ì •ë³´ìˆ˜ì • ìš”ì²­ ëª©ë¡</div>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterRequests('pending')" id="ftPending">â³ ëŒ€ê¸°ì¤‘</button>
                    <button class="filter-tab" onclick="filterRequests('approved')" id="ftApproved">âœ… ìŠ¹ì¸ë¨</button>
                    <button class="filter-tab" onclick="filterRequests('rejected')" id="ftRejected">âŒ ê±°ì ˆë¨</button>
                    <button class="filter-tab" onclick="filterRequests('all')" id="ftAll">ì „ì²´</button>
                </div>
                <div class="request-list" id="requestList">
                    <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
                </div>
            </div>
        </div>

        <!-- CSV ì—…ë¡œë“œ íƒ­ -->
        <div class="tab-content" id="tabContentUpload">
            <div class="steps">
                <div class="step active" id="step1"><span class="step-num">1</span> CSV íŒŒì¼ ì„ íƒ</div>
                <div class="step" id="step2"><span class="step-num">2</span> ë¯¸ë¦¬ë³´ê¸° í™•ì¸</div>
                <div class="step" id="step3"><span class="step-num">3</span> ì»¬ëŸ¼ ë§¤í•‘</div>
                <div class="step" id="step4"><span class="step-num">4</span> ì—…ë¡œë“œ</div>
            </div>

            <div class="section" id="sectionUpload">
                <div class="section-title"><i class="fas fa-file-csv"></i> Step 1. CSV íŒŒì¼ ì„ íƒ</div>
                <div class="template-bar">
                    <span><i class="fas fa-download"></i> ì˜¬ë°”ë¥¸ í˜•ì‹ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</span>
                    <button class="btn btn-outline btn-sm" onclick="downloadTemplate()"><i class="fas fa-file-download"></i> CSV í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Python í¬ë¡¤ë§ ë“±ìœ¼ë¡œ ìˆ˜ì§‘í•œ ê°€ê²Œ ë°ì´í„°ë¥¼ CSVë¡œ ì •ë¦¬í•œ í›„ ì—…ë¡œë“œí•˜ì„¸ìš”. ì»¬ëŸ¼ ì´ë¦„ì´ ë‹¬ë¼ë„ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë§¤í•‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                </div>
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</h3>
                    <p>ì§€ì› í˜•ì‹: .csv, .tsv (UTF-8 ì¸ì½”ë”© ê¶Œì¥, ìµœëŒ€ 10MB)</p>
                    <input type="file" id="fileInput" accept=".csv,.tsv,.txt">
                </div>
            </div>

            <div class="section hidden" id="sectionPreview">
                <div class="section-title"><i class="fas fa-table"></i> Step 2. ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</div>
                <div class="alert alert-info" id="previewAlert"></div>
                <div class="preview-wrapper">
                    <table class="preview-table"><thead id="previewHead"></thead><tbody id="previewBody"></tbody></table>
                </div>
                <div class="preview-info"><span id="previewCount"></span><span>ì²˜ìŒ 20í–‰ë§Œ ë¯¸ë¦¬ë³´ê¸°ë¡œ í‘œì‹œë©ë‹ˆë‹¤</span></div>
                <div class="actions-bar">
                    <button class="btn btn-outline" onclick="goStep(1)"><i class="fas fa-arrow-left"></i> ë‹¤ì‹œ ì„ íƒ</button>
                    <button class="btn btn-primary" onclick="goStep(3)">ì»¬ëŸ¼ ë§¤í•‘í•˜ê¸° <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div class="section hidden" id="sectionMapping">
                <div class="section-title"><i class="fas fa-exchange-alt"></i> Step 3. ì»¬ëŸ¼ ë§¤í•‘</div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>CSV ì»¬ëŸ¼ì„ í‚¤ì¦ˆê³  DB í•„ë“œì— ì—°ê²°í•˜ì„¸ìš”. <b>name(ê°€ê²Œì´ë¦„)</b>ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.</span>
                </div>
                <div class="mapping-grid" id="mappingGrid"></div>
                <div style="margin-top:20px; padding:16px; background:#f8f9fa; border-radius:12px;">
                    <div class="section-title" style="margin-bottom:12px;"><i class="fas fa-cog"></i> ê¸°ì¡´ ë°ì´í„° ì²˜ë¦¬</div>
                    <div class="existing-controls">
                        <div class="radio-group">
                            <label><input type="radio" name="existingData" value="keep" checked> ê¸°ì¡´ ë°ì´í„° ìœ ì§€ + ì¶”ê°€</label>
                            <label><input type="radio" name="existingData" value="clear"> ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ êµì²´</label>
                        </div>
                    </div>
                </div>
                <div class="actions-bar">
                    <button class="btn btn-outline" onclick="goStep(2)"><i class="fas fa-arrow-left"></i> ë¯¸ë¦¬ë³´ê¸°</button>
                    <button class="btn btn-primary" id="btnStartUpload" onclick="startUpload()"><i class="fas fa-upload"></i> ì—…ë¡œë“œ ì‹œì‘</button>
                </div>
            </div>

            <div class="section hidden" id="sectionResult">
                <div class="section-title"><i class="fas fa-rocket"></i> Step 4. ì—…ë¡œë“œ ì§„í–‰</div>
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText">ì¤€ë¹„ ì¤‘...</div>
                <div class="result-log" id="resultLog"></div>
                <div class="actions-bar" id="resultActions" style="display:none;">
                    <button class="btn btn-outline" onclick="location.reload()"><i class="fas fa-redo"></i> ìƒˆë¡œ ì—…ë¡œë“œ</button>
                    <button class="btn btn-primary" onclick="location.href='index.html'"><i class="fas fa-home"></i> ë©”ì¸ì—ì„œ í™•ì¸</button>
                </div>
            </div>
        </div><!-- /tabContentUpload -->
    </div><!-- /container -->
</div><!-- /adminWrap -->

<script>
// ===== Supabase ì´ˆê¸°í™” (Vercel í™˜ê²½ë³€ìˆ˜ ì£¼ì…) =====
// vercel.json ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì•„ë˜ ê°’ì´ ì£¼ì…ë©ë‹ˆë‹¤
const SUPABASE_URL = 'https://vzjqfogqymthtmbzyxkz.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_911v8puVJ_Qm-iex5F1gcg_suBEEkur';
let sb = null;
let allRequests = [];
let currentFilter = 'pending';

// ===== DOMContentLoaded =====
document.addEventListener('DOMContentLoaded', () => {
    // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    if (!SUPABASE_URL.includes('%%')) {
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        checkSession();
    } else {
        // í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì • â†’ URL/Key ì§ì ‘ ì…ë ¥ í¼ í‘œì‹œ
        showManualInput();
    }
    setupDragDrop();
    document.getElementById('fileInput').addEventListener('change', handleFile);
});

// í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì • ì‹œ ë¡œê·¸ì¸ í¼ì— ì…ë ¥ í•„ë“œ ì¶”ê°€
function showManualInput() {
    const loginBox = document.querySelector('.login-box');
    const extraHtml = `
        <div style="margin-bottom:20px; padding:14px; background:#f0fffe; border-radius:10px; border:1px solid #b2ebf2;">
            <p style="font-size:0.78rem; color:#0984e3; margin-bottom:10px;"><i class="fas fa-info-circle"></i> Vercel í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•„ë˜ì— ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>
            <div style="margin-bottom:8px;">
                <label style="font-size:0.78rem; font-weight:600; display:block; margin-bottom:4px;">Supabase Project URL</label>
                <input type="text" id="manualUrl" placeholder="https://xxxx.supabase.co" style="width:100%; padding:8px 12px; border:1.5px solid #b2ebf2; border-radius:8px; font-size:0.82rem;">
            </div>
            <div>
                <label style="font-size:0.78rem; font-weight:600; display:block; margin-bottom:4px;">Supabase Anon Key</label>
                <input type="password" id="manualKey" placeholder="eyJ..." style="width:100%; padding:8px 12px; border:1.5px solid #b2ebf2; border-radius:8px; font-size:0.82rem;">
            </div>
        </div>
    `;
    loginBox.querySelector('.login-logo').insertAdjacentHTML('afterend', extraHtml);
}

// ===== ì„¸ì…˜ í™•ì¸ =====
async function checkSession() {
    if (!sb) return;
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
        showAdmin(session.user.email);
    }
}

// ===== ë¡œê·¸ì¸ =====
async function doLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');
    const btn = document.getElementById('loginBtn');

    if (!email || !password) {
        errorEl.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        errorEl.style.display = 'block';
        return;
    }

    // í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì • ì‹œ sb ì¬ì´ˆê¸°í™”
    if (!sb || SUPABASE_URL.includes('%%')) {
        const url = document.getElementById('manualUrl')?.value.trim();
        const key = document.getElementById('manualKey')?.value.trim();
        if (!url || !key) {
            errorEl.textContent = 'Supabase URLê³¼ Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            errorEl.style.display = 'block';
            return;
        }
        sb = supabase.createClient(url, key);
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¡œê·¸ì¸ ì¤‘...';
    errorEl.style.display = 'none';

    const { data, error } = await sb.auth.signInWithPassword({ email, password });

    if (error) {
        errorEl.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸';
        return;
    }

    showAdmin(data.user.email);
}

// ===== ê´€ë¦¬ì í™”ë©´ í‘œì‹œ =====
async function showAdmin(email) {
    document.getElementById('loginWrap').style.display = 'none';
    document.getElementById('adminWrap').style.display = 'block';
    document.getElementById('headerUser').textContent = email;
    await loadRequests();
    loadStats();
}

// ===== ë¡œê·¸ì•„ì›ƒ =====
async function doLogout() {
    if (!sb) return;
    await sb.auth.signOut();
    location.reload();
}

// ===== íƒ­ ì „í™˜ =====
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => { c.classList.remove('active'); c.style.display = 'none'; });
    if (tab === 'requests') {
        document.getElementById('tabRequests').classList.add('active');
        document.getElementById('tabContentRequests').style.display = 'block';
        document.getElementById('tabContentRequests').classList.add('active');
    } else {
        document.getElementById('tabUpload').classList.add('active');
        document.getElementById('tabContentUpload').style.display = 'block';
        document.getElementById('tabContentUpload').classList.add('active');
    }
}

// ===== ìˆ˜ì •ìš”ì²­ ë¡œë“œ =====
async function loadRequests() {
    if (!sb) return;
    const { data, error } = await sb.from('edit_requests').select('*').order('created_at', { ascending: false });
    if (error) { console.error(error); return; }
    allRequests = data || [];
    const pendingCount = allRequests.filter(r => r.status === 'pending').length;
    document.getElementById('pendingBadge').textContent = pendingCount;
    renderRequests();
}

// ===== í•„í„° =====
function filterRequests(status) {
    currentFilter = status;
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    const map = { pending: 'ftPending', approved: 'ftApproved', rejected: 'ftRejected', all: 'ftAll' };
    document.getElementById(map[status]).classList.add('active');
    renderRequests();
}

// ===== ìˆ˜ì • í•­ëª©ë³„ ì„¤ì • =====
const FIELD_MAP = {
    'ì˜ì—…ì‹œê°„': 'hours',
    'ì „í™”ë²ˆí˜¸': 'phone',
    'ì£¼ì†Œ': 'address',
    'í‚¤ì¦ˆì¡´ì •ë³´': 'playroom_desc',
};
const MANUAL_FIELDS = ['í¸ì˜ì‹œì„¤', 'íì—…', 'ê¸°íƒ€'];

// ===== ìˆ˜ì •ìš”ì²­ ë Œë”ë§ =====
function renderRequests() {
    const list = document.getElementById('requestList');
    const filtered = currentFilter === 'all' ? allRequests : allRequests.filter(r => r.status === currentFilter);

    if (filtered.length === 0) {
        const msgs = { pending: 'ëŒ€ê¸° ì¤‘ì¸ ìˆ˜ì •ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.', approved: 'ìŠ¹ì¸ëœ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.', rejected: 'ê±°ì ˆëœ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.', all: 'ìˆ˜ì •ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.' };
        list.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>${msgs[currentFilter]}</p></div>`;
        return;
    }

    list.innerHTML = filtered.map(req => {
        const date = new Date(req.created_at).toLocaleString('ko-KR');
        const isManual = MANUAL_FIELDS.includes(req.field_name);
        const statusBadge = {
            pending: '<span class="status-badge status-pending">â³ ëŒ€ê¸°ì¤‘</span>',
            approved: '<span class="status-badge status-approved">âœ… ìŠ¹ì¸ë¨</span>',
            rejected: '<span class="status-badge status-rejected">âŒ ê±°ì ˆë¨</span>',
        }[req.status] || '';

        let actions = statusBadge;
        if (req.status === 'pending') {
            if (isManual) {
                actions = `
                    <button class="btn btn-sm btn-danger" onclick="rejectRequest(${req.id})"><i class="fas fa-times"></i> ê±°ì ˆ</button>
                    <button class="btn btn-sm btn-purple" onclick="toggleManualEdit(${req.id})"><i class="fas fa-pen"></i> ì§ì ‘ ìˆ˜ì •</button>
                `;
            } else {
                actions = `
                    <button class="btn btn-sm btn-danger" onclick="rejectRequest(${req.id})"><i class="fas fa-times"></i> ê±°ì ˆ</button>
                    <button class="btn btn-sm btn-secondary" onclick="approveRequest(${req.id}, '${escStr(req.store_name)}', '${escStr(req.field_name)}', '${escStr(req.new_value)}')"><i class="fas fa-check"></i> ìŠ¹ì¸</button>
                `;
            }
        }

        // í¸ì˜ì‹œì„¤ ì§ì ‘ í¸ì§‘ í¼
        const manualForm = isManual && req.status === 'pending' ? `
        <div class="manual-edit-form" id="manualForm-${req.id}">
            <label>ğŸ”§ "${escHtml(req.store_name)}" ê°€ê²Œ ì •ë³´ë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”</label>
            <div style="font-size:0.78rem; color:#6c5ce7; margin-bottom:10px;">
                ì‚¬ìš©ì ìš”ì²­ ë‚´ìš©: <b>${escHtml(req.new_value)}</b>
                ${req.reason ? ` / ì‚¬ìœ : ${escHtml(req.reason)}` : ''}
            </div>
            <div class="manual-edit-grid">
                <div class="edit-field"><label>ì£¼ì°¨ ê°€ëŠ¥</label><select id="ef-parking-${req.id}"><option value="">ë³€ê²½ ì•ˆ í•¨</option><option value="true">ìˆìŒ</option><option value="false">ì—†ìŒ</option></select></div>
                <div class="edit-field"><label>ìˆ˜ìœ ì‹¤</label><select id="ef-nursing-${req.id}"><option value="">ë³€ê²½ ì•ˆ í•¨</option><option value="true">ìˆìŒ</option><option value="false">ì—†ìŒ</option></select></div>
                <div class="edit-field"><label>ìœ ì•„ì˜ì</label><select id="ef-highchair-${req.id}"><option value="">ë³€ê²½ ì•ˆ í•¨</option><option value="true">ìˆìŒ</option><option value="false">ì—†ìŒ</option></select></div>
                <div class="edit-field"><label>ìœ ëª¨ì°¨ ì ‘ê·¼</label><select id="ef-stroller-${req.id}"><option value="">ë³€ê²½ ì•ˆ í•¨</option><option value="true">ìˆìŒ</option><option value="false">ì—†ìŒ</option></select></div>
                ${req.field_name === 'íì—…' ? `<div class="edit-field"><label>ê°€ê²Œ ìƒíƒœ (íì—… ì‹œ ì´ë¦„ì— [íì—…] ì¶”ê°€)</label><input type="text" id="ef-name-${req.id}" placeholder="ì˜ˆ: ë§›ìˆëŠ”ê³ ê¸°ì§‘ [íì—…]"></div>` : ''}
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn btn-sm btn-outline" onclick="toggleManualEdit(${req.id})">ì·¨ì†Œ</button>
                <button class="manual-save-btn" onclick="saveManualEdit(${req.id}, '${escStr(req.store_name)}')"><i class="fas fa-save"></i> ì €ì¥ ë° ìŠ¹ì¸</button>
            </div>
        </div>` : '';

        return `
        <div class="request-card ${req.status}${isManual && req.status==='pending' ? ' manual' : ''}" id="req-${req.id}">
            <div class="request-header">
                <div>
                    <div class="request-store">ğŸª ${escHtml(req.store_name)}</div>
                    <span class="request-field ${isManual ? 'manual-tag' : ''}">${escHtml(req.field_name)}</span>
                </div>
                <div class="request-date">${date}</div>
            </div>
            <div class="request-values">
                <div class="val-box val-old">${escHtml(req.old_value || '(ì—†ìŒ)')}</div>
                <div class="val-arrow">â†’</div>
                <div class="val-box val-new">${escHtml(req.new_value)}</div>
            </div>
            ${req.reason ? `<div class="request-reason">ğŸ’¬ ì‚¬ìœ : ${escHtml(req.reason)}</div>` : ''}
            <div class="request-actions">${actions}</div>
            ${manualForm}
        </div>`;
    }).join('');
}

function escHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function escStr(str) {
    if (!str) return '';
    return String(str).replace(/'/g,"\\'").replace(/"/g,'\\"');
}

// ===== ì§ì ‘ ìˆ˜ì • í¼ í† ê¸€ =====
function toggleManualEdit(id) {
    const form = document.getElementById(`manualForm-${id}`);
    if (form) form.classList.toggle('open');
}

// ===== ìˆ˜ë™ í•­ëª© ì €ì¥ =====
async function saveManualEdit(id, storeName) {
    if (!sb) return;
    try {
        const { data: stores, error: findErr } = await sb.from('stores').select('id').ilike('name', storeName).limit(1);
        if (findErr) throw findErr;
        if (!stores || stores.length === 0) {
            alert(`"${storeName}" ê°€ê²Œë¥¼ stores í…Œì´ë¸”ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        const storeId = stores[0].id;
        const updates = {};

        const parking = document.getElementById(`ef-parking-${id}`)?.value;
        const nursing = document.getElementById(`ef-nursing-${id}`)?.value;
        const highchair = document.getElementById(`ef-highchair-${id}`)?.value;
        const stroller = document.getElementById(`ef-stroller-${id}`)?.value;
        const name = document.getElementById(`ef-name-${id}`)?.value.trim();

        if (parking !== '') updates.has_parking = parking === 'true';
        if (nursing !== '') updates.has_nursing_room = nursing === 'true';
        if (highchair !== '') updates.has_highchair = highchair === 'true';
        if (stroller !== '') updates.has_stroller_access = stroller === 'true';
        if (name) updates.name = name;

        if (Object.keys(updates).length === 0) {
            alert('ë³€ê²½í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const { error: updateErr } = await sb.from('stores').update(updates).eq('id', storeId);
        if (updateErr) throw updateErr;

        const { error: statusErr } = await sb.from('edit_requests').update({ status: 'approved' }).eq('id', id);
        if (statusErr) throw statusErr;

        allRequests = allRequests.map(r => r.id === id ? {...r, status: 'approved'} : r);
        document.getElementById('pendingBadge').textContent = allRequests.filter(r => r.status === 'pending').length;
        renderRequests();
        showToast('âœ… ì €ì¥ ì™„ë£Œ! stores í…Œì´ë¸”ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch(e) {
        alert('ì˜¤ë¥˜: ' + e.message);
    }
}

// ===== ìë™ ìŠ¹ì¸ =====
async function approveRequest(id, storeName, fieldName, newValue) {
    if (!sb) return;
    if (!confirm(`"${storeName}"ì˜ ${fieldName}ì„ "${newValue}"ë¡œ ë³€ê²½í• ê¹Œìš”?`)) return;
    try {
        const { data: stores, error: findErr } = await sb.from('stores').select('id').ilike('name', storeName).limit(1);
        if (findErr) throw findErr;
        if (!stores || stores.length === 0) { alert(`"${storeName}" ê°€ê²Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }

        const mappedField = FIELD_MAP[fieldName] || fieldName;
        let parsedValue = newValue;
        if (['has_parking','has_nursing_room','has_highchair','has_stroller_access'].includes(mappedField)) {
            parsedValue = ['true','1','o','O','ì˜ˆ','Y','y','ìˆìŒ','ê°€ëŠ¥'].includes(newValue);
        } else if (['lat','lng','rating'].includes(mappedField)) {
            parsedValue = parseFloat(newValue);
        } else if (mappedField === 'review_count') {
            parsedValue = parseInt(newValue);
        }

        const { error: updateErr } = await sb.from('stores').update({ [mappedField]: parsedValue }).eq('id', stores[0].id);
        if (updateErr) throw updateErr;

        const { error: statusErr } = await sb.from('edit_requests').update({ status: 'approved' }).eq('id', id);
        if (statusErr) throw statusErr;

        allRequests = allRequests.map(r => r.id === id ? {...r, status: 'approved'} : r);
        document.getElementById('pendingBadge').textContent = allRequests.filter(r => r.status === 'pending').length;
        renderRequests();
        showToast('âœ… ìŠ¹ì¸ ì™„ë£Œ!');
    } catch(e) { alert('ì˜¤ë¥˜: ' + e.message); }
}

// ===== ê±°ì ˆ =====
async function rejectRequest(id) {
    if (!sb) return;
    if (!confirm('ì´ ìš”ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        const { error } = await sb.from('edit_requests').update({ status: 'rejected' }).eq('id', id);
        if (error) throw error;
        allRequests = allRequests.map(r => r.id === id ? {...r, status: 'rejected'} : r);
        document.getElementById('pendingBadge').textContent = allRequests.filter(r => r.status === 'pending').length;
        renderRequests();
        showToast('âŒ ê±°ì ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch(e) { alert('ì˜¤ë¥˜: ' + e.message); }
}

// ===== í† ìŠ¤íŠ¸ =====
function showToast(msg) {
    const t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:9999;background:#2d3748;color:white;padding:14px 20px;border-radius:12px;font-size:0.85rem;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,0.2);';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

// ===== Stats =====
async function loadStats() {
    try {
        const r = await fetch('tables/stores?limit=1');
        const res = await r.json();
        const total = res.total || 0;
        document.getElementById('statTotal').textContent = total.toLocaleString();
        if (total > 0) {
            let allData = [];
            const pages = Math.ceil(Math.min(total, 500) / 100);
            for (let p = 1; p <= pages; p++) {
                const pr = await fetch(`tables/stores?page=${p}&limit=100`);
                const pres = await pr.json();
                allData = allData.concat(pres.data || []);
            }
            document.getElementById('statCat').textContent = new Set(allData.map(d => d.category).filter(Boolean)).size;
            document.getElementById('statRegion').textContent = new Set(allData.map(d => d.region).filter(Boolean)).size;
            document.getElementById('statAvgRating').textContent = (allData.reduce((s,d) => s + (d.rating||0), 0) / allData.length).toFixed(1);
        }
    } catch(e) { console.error(e); }
}

// ===== CSV ì—…ë¡œë“œ =====
let csvData = null;
let mapping = {};

const DB_FIELDS = [
    { key: 'name', label: 'ê°€ê²Œ ì´ë¦„', required: true },
    { key: 'category', label: 'ì—…ì¢…(ëŒ€ë¶„ë¥˜)', required: false, hint: 'ì‹ë‹¹/ì¹´í˜/í‚¤ì¦ˆì¹´í˜/ë·”í˜/ë² ì´ì»¤ë¦¬' },
    { key: 'subcategory', label: 'ì„¸ë¶€ì—…ì¢…', required: false },
    { key: 'region', label: 'ì§€ì—­(ì‹œ/ë„)', required: false },
    { key: 'district', label: 'êµ¬/êµ°', required: false },
    { key: 'address', label: 'ìƒì„¸ì£¼ì†Œ', required: false },
    { key: 'lat', label: 'ìœ„ë„', required: false },
    { key: 'lng', label: 'ê²½ë„', required: false },
    { key: 'phone', label: 'ì „í™”ë²ˆí˜¸', required: false },
    { key: 'hours', label: 'ì˜ì—…ì‹œê°„', required: false },
    { key: 'playroom_type', label: 'ë†€ì´ë°© ìœ í˜•', required: false },
    { key: 'playroom_desc', label: 'ë†€ì´ë°© ì„¤ëª…', required: false },
    { key: 'age_range', label: 'ê¶Œì¥ ì—°ë ¹', required: false },
    { key: 'has_parking', label: 'ì£¼ì°¨ ì—¬ë¶€', required: false },
    { key: 'has_nursing_room', label: 'ìˆ˜ìœ ì‹¤ ì—¬ë¶€', required: false },
    { key: 'has_highchair', label: 'ìœ ì•„ì˜ì ì—¬ë¶€', required: false },
    { key: 'has_stroller_access', label: 'ìœ ëª¨ì°¨ ì ‘ê·¼', required: false },
    { key: 'price_range', label: 'ê°€ê²©ëŒ€', required: false },
    { key: 'rating', label: 'í‰ì ', required: false },
    { key: 'review_count', label: 'ë¦¬ë·° ìˆ˜', required: false },
    { key: 'tags', label: 'íƒœê·¸', required: false },
    { key: 'description', label: 'ê°€ê²Œ ì†Œê°œ', required: false },
];

function setupDragDrop() {
    const zone = document.getElementById('uploadZone');
    if (!zone) return;
    ['dragenter','dragover'].forEach(e => zone.addEventListener(e, ev => { ev.preventDefault(); zone.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(e => zone.addEventListener(e, ev => { ev.preventDefault(); zone.classList.remove('dragover'); }));
    zone.addEventListener('drop', ev => { const f = ev.dataTransfer.files[0]; if (f) parseFile(f); });
}

function handleFile(e) { const f = e.target.files[0]; if (f) parseFile(f); }

function parseFile(file) {
    Papa.parse(file, {
        header: true, skipEmptyLines: true,
        complete: r => { csvData = { headers: r.meta.fields, rows: r.data }; goStep(2); showPreview(); },
        error: e => alert('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ' + e.message)
    });
}

function showPreview() {
    const h = csvData.headers;
    document.getElementById('previewHead').innerHTML = '<tr>' + h.map(c => `<th>${c}</th>`).join('') + '</tr>';
    document.getElementById('previewBody').innerHTML = csvData.rows.slice(0,20).map(r => '<tr>' + h.map(c => `<td title="${r[c]||''}">${r[c]||''}</td>`).join('') + '</tr>').join('');
    document.getElementById('previewCount').textContent = `ì „ì²´ ${csvData.rows.length}í–‰`;
    document.getElementById('previewAlert').innerHTML = `<i class="fas fa-check-circle"></i> <span>${csvData.rows.length}ê±´ íŒŒì‹± ì™„ë£Œ. ì»¬ëŸ¼ ${h.length}ê°œ ê°ì§€.</span>`;
}

function buildMapping() {
    const grid = document.getElementById('mappingGrid');
    grid.innerHTML = DB_FIELDS.map(f => {
        const opts = ['<option value="">-- ì„ íƒ ì•ˆ í•¨ --</option>'].concat(
            csvData.headers.map(h => {
                const sel = h.toLowerCase().includes(f.key.toLowerCase()) || f.key.toLowerCase().includes(h.toLowerCase()) ? 'selected' : '';
                return `<option value="${h}" ${sel}>${h}</option>`;
            })
        ).join('');
        return `<div class="mapping-item">
            <span class="field-name">${f.label}${f.required ? '<span class="field-required"> *</span>' : ''}</span>
            <i class="fas fa-arrow-right"></i>
            <select data-field="${f.key}" onchange="updateMapping(this)">${opts}</select>
        </div>`;
    }).join('');
    document.querySelectorAll('.mapping-item select').forEach(s => updateMapping(s));
}

function updateMapping(sel) {
    mapping[sel.dataset.field] = sel.value;
    sel.className = sel.value ? 'mapped' : 'unmapped';
}

function goStep(n) {
    [1,2,3,4].forEach(i => {
        const s = document.getElementById('step'+i);
        s.className = 'step' + (i < n ? ' done' : (i === n ? ' active' : ''));
    });
    document.getElementById('sectionUpload').classList.toggle('hidden', n !== 1);
    document.getElementById('sectionPreview').classList.toggle('hidden', n !== 2);
    document.getElementById('sectionMapping').classList.toggle('hidden', n !== 3);
    document.getElementById('sectionResult').classList.toggle('hidden', n !== 4);
    if (n === 3) buildMapping();
}

async function startUpload() {
    if (!csvData || csvData.rows.length === 0) { alert('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    if (!confirm(`ì´ ${csvData.rows.length}ê±´ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    goStep(4);
    const log = document.getElementById('resultLog');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    log.innerHTML = '';
    function addLog(msg, type='info') { log.innerHTML += `<div class="${type}">  ${msg}</div>`; log.scrollTop = log.scrollHeight; }

    const existingAction = document.querySelector('input[name="existingData"]:checked').value;
    if (existingAction === 'clear') {
        addLog('âš ï¸ ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì‹œì‘...', 'warn');
        try {
            while (true) {
                const r = await fetch('tables/stores?page=1&limit=100');
                const res = await r.json();
                const data = res.data || [];
                if (data.length === 0) break;
                await Promise.all(data.map(d => fetch(`tables/stores/${d.id}`, { method: 'DELETE' })));
                addLog(`  ğŸ—‘ï¸ ${data.length}ê±´ ì‚­ì œ`, 'warn');
            }
            addLog('âœ… ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ', 'success');
        } catch(e) { addLog('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + e.message, 'error'); }
    }

    addLog(`ğŸ“‹ ${csvData.rows.length}ê±´ ë³€í™˜ ì‹œì‘...`, 'info');
    const records = []; let skipCount = 0;
    csvData.rows.forEach(row => {
        const record = {};
        DB_FIELDS.forEach(field => {
            const csvCol = mapping[field.key];
            if (csvCol && row[csvCol] !== undefined && row[csvCol] !== '') {
                let val = String(row[csvCol]).trim();
                if (['lat','lng','rating'].includes(field.key)) val = parseFloat(val) || 0;
                else if (field.key === 'review_count') val = parseInt(val) || 0;
                else if (['has_parking','has_nursing_room','has_highchair','has_stroller_access'].includes(field.key)) val = ['true','1','o','O','ì˜ˆ','Y','y','ìˆìŒ','ê°€ëŠ¥'].includes(val);
                else if (field.key === 'tags') val = val.split(/[,;|]/).map(t => t.trim()).filter(Boolean);
                else if (field.key === 'price_range') { if (['ì €ë ´','ì‹¸ë‹¤','ë‚®ìŒ','low'].includes(val.toLowerCase())) val='$'; else if (['ë³´í†µ','ì¤‘ê°„','medium','mid'].includes(val.toLowerCase())) val='$$'; else if (['ê³ ê¸‰','ë¹„ìŒˆ','ë†’ìŒ','high','í”„ë¦¬ë¯¸ì—„'].includes(val.toLowerCase())) val='$$$'; }
                record[field.key] = val;
            }
        });
        if (!record.name) { skipCount++; return; }
        if (!record.category) record.category = 'ì‹ë‹¹';
        if (!record.subcategory) record.subcategory = 'í•œì‹';
        if (!record.region) { const addr = record.address || ''; record.region = ['ì„œìš¸','ê²½ê¸°','ì¸ì²œ','ë¶€ì‚°','ëŒ€êµ¬','ëŒ€ì „','ê´‘ì£¼','ìš¸ì‚°','ê²½ë‚¨','ì¶©ë¶','ì¶©ë‚¨','ê°•ì›','ì œì£¼'].find(r => addr.includes(r)) || 'ì„œìš¸'; }
        if (!record.playroom_type) record.playroom_type = 'í‚¤ì¦ˆì¡´';
        if (!record.age_range) record.age_range = 'ì „ì—°ë ¹';
        if (!record.price_range) record.price_range = '$$';
        if (!record.rating) record.rating = +(3.5 + Math.random() * 1.5).toFixed(1);
        if (!record.review_count) record.review_count = Math.floor(10 + Math.random() * 200);
        if (!record.tags || record.tags.length === 0) record.tags = ['ê°€ì¡±ì™¸ì‹', 'ì•„ì´'];
        if (!record.description) record.description = record.playroom_desc || 'í‚¤ì¦ˆí”„ë Œë“¤ë¦¬ ê°€ê²Œì…ë‹ˆë‹¤.';
        records.push(record);
    });
    addLog(`âœ… ë³€í™˜ ì™„ë£Œ: ${records.length}ê±´ (ìŠ¤í‚µ: ${skipCount}ê±´)`, 'success');

    if (records.length === 0) { addLog('âŒ ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); document.getElementById('resultActions').style.display = 'flex'; return; }

    addLog(`ğŸš€ API ì—…ë¡œë“œ ì‹œì‘ (${records.length}ê±´)...`, 'info');
    const batchSize = 20; let uploaded = 0; let errors = 0;
    for (let i = 0; i < records.length; i += batchSize) {
        const batch = records.slice(i, i + batchSize);
        const results = await Promise.allSettled(batch.map(rec => fetch('tables/stores', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(rec) })));
        results.forEach((r, j) => { if (r.status === 'fulfilled' && r.value.ok) uploaded++; else { errors++; addLog(`  âš ï¸ [${i+j+1}] ${batch[j].name} ì‹¤íŒ¨`, 'error'); } });
        const pct = Math.round(((i + batch.length) / records.length) * 100);
        progressFill.style.width = pct + '%';
        progressText.textContent = `${uploaded}/${records.length} ì—…ë¡œë“œ ì™„ë£Œ (${pct}%)`;
    }
    progressFill.style.width = '100%';
    addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    addLog(`ğŸ‰ ì—…ë¡œë“œ ì™„ë£Œ! âœ… ì„±ê³µ: ${uploaded}ê±´${errors > 0 ? ` / âŒ ì‹¤íŒ¨: ${errors}ê±´` : ''}`, 'success');
    addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    progressText.textContent = `ì™„ë£Œ! ${uploaded}ê±´ ì—…ë¡œë“œ ì„±ê³µ`;
    document.getElementById('resultActions').style.display = 'flex';
}

function downloadTemplate() {
    const headers = DB_FIELDS.map(f => f.key);
    const example = { name:'ë§›ìˆëŠ” ê³ ê¸°ì§‘', category:'ì‹ë‹¹', subcategory:'ê³ ê¸°ì§‘', region:'ì„œìš¸', district:'ê°•ë‚¨êµ¬', address:'ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123', lat:'37.498', lng:'127.028', phone:'02-123-4567', hours:'11:00~22:00 (ì›” íœ´ë¬´)', playroom_type:'ì‹¤ë‚´ë†€ì´ë°©', playroom_desc:'ë³¼í’€+ë¯¸ë„ëŸ¼í‹€ í‚¤ì¦ˆì¡´ ìš´ì˜', age_range:'ì „ì—°ë ¹', has_parking:'O', has_nursing_room:'O', has_highchair:'O', has_stroller_access:'O', price_range:'$$', rating:'4.3', review_count:'150', tags:'í•œìš°,ìˆ¯ë¶ˆêµ¬ì´,ìƒì¼íŒŒí‹°', description:'í”„ë¦¬ë¯¸ì—„ í•œìš° ì „ë¬¸ì ' };
    const csv = headers.join(',') + '\n' + headers.map(h => `"${example[h] || ''}"`).join(',') + '\n';
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'kidsgo_template.csv'; a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>