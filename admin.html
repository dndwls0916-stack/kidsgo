<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‚¤ì¦ˆê³  ê´€ë¦¬ì - CSV ë°ì´í„° ì—…ë¡œë“œ</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <!-- CSV íŒŒì„œ -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        :root {
            --primary: #FF6B9D;
            --primary-dark: #E85588;
            --primary-light: #FFD4E3;
            --secondary: #4ECDC4;
            --bg: #FFF8F0;
            --card: #FFFFFF;
            --text: #2D3436;
            --text-light: #636E72;
            --border: #E8E8E8;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #e17055;
            --font: 'Noto Sans KR', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 16px 24px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header h1 { font-size: 1.1rem; font-weight: 700; }
        .header h1 i { margin-right: 8px; }
        .header a { color: white; text-decoration: none; font-size: 0.85rem; opacity: 0.9; }
        .header a:hover { opacity: 1; }

        /* Container */
        .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }

        /* Stats Bar */
        .stats-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px; margin-bottom: 24px;
        }
        .stat-card {
            background: var(--card); border-radius: 12px; padding: 16px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .stat-card .num { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-card .label { font-size: 0.75rem; color: var(--text-light); margin-top: 4px; }

        /* Sections */
        .section {
            background: var(--card); border-radius: 16px; padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 24px;
        }
        .section-title {
            font-size: 1rem; font-weight: 700; margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .section-title i { color: var(--primary); }

        /* Step Indicator */
        .steps {
            display: flex; gap: 4px; margin-bottom: 24px;
        }
        .step {
            flex: 1; text-align: center; padding: 10px 8px;
            background: #f1f2f6; border-radius: 8px; font-size: 0.78rem;
            font-weight: 500; color: var(--text-light); transition: all 0.3s;
            position: relative;
        }
        .step.active { background: var(--primary); color: white; }
        .step.done { background: var(--success); color: white; }
        .step .step-num {
            display: inline-flex; align-items: center; justify-content: center;
            width: 22px; height: 22px; border-radius: 50%;
            background: rgba(255,255,255,0.3); font-size: 0.7rem;
            font-weight: 700; margin-right: 4px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2.5px dashed var(--border); border-radius: 16px;
            padding: 48px 24px; text-align: center; cursor: pointer;
            transition: all 0.3s; position: relative;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary); background: rgba(255,107,157,0.04);
        }
        .upload-zone i { font-size: 2.5rem; color: var(--primary-light); margin-bottom: 12px; }
        .upload-zone h3 { font-size: 1rem; margin-bottom: 8px; }
        .upload-zone p { font-size: 0.82rem; color: var(--text-light); }
        .upload-zone input { display: none; }

        /* Template Download */
        .template-bar {
            display: flex; align-items: center; justify-content: space-between;
            background: linear-gradient(135deg, #f0fffe 0%, #fff5f8 100%);
            border-radius: 12px; padding: 14px 18px; margin-bottom: 16px;
            border: 1px solid #e0f5f3;
        }
        .template-bar span { font-size: 0.82rem; color: var(--text-light); }
        .template-bar span i { color: var(--secondary); margin-right: 6px; }
        
        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 10px 20px; border-radius: 10px; border: none;
            font-family: var(--font); font-size: 0.85rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: var(--secondary-dark); }
        .btn-outline {
            background: white; color: var(--primary); border: 1.5px solid var(--primary);
        }
        .btn-outline:hover { background: var(--primary-light); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #d63031; }
        .btn-sm { padding: 7px 14px; font-size: 0.78rem; }

        /* Preview Table */
        .preview-wrapper {
            overflow-x: auto; border: 1px solid var(--border);
            border-radius: 12px; max-height: 400px; overflow-y: auto;
        }
        .preview-table {
            width: 100%; border-collapse: collapse; font-size: 0.78rem;
            min-width: 800px;
        }
        .preview-table th {
            background: #f8f9fa; position: sticky; top: 0; z-index: 2;
            padding: 10px 12px; text-align: left; font-weight: 600;
            border-bottom: 2px solid var(--border); white-space: nowrap;
        }
        .preview-table td {
            padding: 8px 12px; border-bottom: 1px solid #f1f2f6;
            max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .preview-table tr:hover td { background: #fef9f0; }
        .preview-info { 
            padding: 12px 16px; background: #f8f9fa; border-top: 1px solid var(--border);
            font-size: 0.78rem; color: var(--text-light); 
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Mapping Section */
        .mapping-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
        }
        .mapping-item {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 14px; background: #f8f9fa; border-radius: 10px;
            font-size: 0.82rem;
        }
        .mapping-item .field-name {
            min-width: 120px; font-weight: 600; color: var(--primary-dark);
        }
        .mapping-item .field-required { color: var(--danger); font-size: 0.7rem; }
        .mapping-item i.fa-arrow-right { color: var(--text-light); font-size: 0.7rem; }
        .mapping-item select {
            flex: 1; padding: 6px 10px; border: 1.5px solid var(--border);
            border-radius: 8px; font-family: var(--font); font-size: 0.8rem;
            background: white; cursor: pointer;
        }
        .mapping-item select:focus { border-color: var(--primary); outline: none; }
        .mapping-item select.mapped { border-color: var(--success); background: #f0fff4; }
        .mapping-item select.unmapped { border-color: var(--warning); }

        /* Progress */
        .progress-bar {
            width: 100%; height: 12px; background: #f1f2f6;
            border-radius: 6px; overflow: hidden; margin: 12px 0;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 6px; transition: width 0.3s; width: 0%;
        }
        .progress-text { font-size: 0.82rem; color: var(--text-light); text-align: center; }

        /* Result Log */
        .result-log {
            background: #1e272e; color: #d2dae2; border-radius: 12px;
            padding: 16px; font-family: 'Courier New', monospace;
            font-size: 0.78rem; max-height: 300px; overflow-y: auto;
            line-height: 1.8;
        }
        .result-log .success { color: #00b894; }
        .result-log .error { color: #e17055; }
        .result-log .info { color: #74b9ff; }
        .result-log .warn { color: #fdcb6e; }

        /* Actions Bar */
        .actions-bar {
            display: flex; gap: 12px; justify-content: flex-end;
            flex-wrap: wrap; margin-top: 16px;
        }

        /* Alert */
        .alert {
            padding: 12px 16px; border-radius: 10px; font-size: 0.82rem;
            margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
        }
        .alert-info { background: #dff9fb; color: #0984e3; border: 1px solid #74b9ff; }
        .alert-warning { background: #ffeaa7; color: #6c5ce7; border: 1px solid #fdcb6e; }
        .alert-success { background: #e0fce7; color: #00b894; border: 1px solid #55efc4; }

        /* Existing data controls */
        .existing-controls {
            display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
        }
        .radio-group { display: flex; gap: 16px; }
        .radio-group label {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.82rem; cursor: pointer;
        }

        /* Hidden sections */
        .hidden { display: none !important; }

        /* Supabase ì„¤ì • */
        .supabase-config {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px; padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); margin-bottom: 24px;
        }
        .supabase-config .section-title { color: #00d4aa; }
        .supabase-config .section-title i { color: #00d4aa; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .config-field label { display: block; font-size: 0.78rem; color: #a0aec0; margin-bottom: 6px; font-weight: 600; }
        .config-field input {
            width: 100%; padding: 10px 14px; border-radius: 10px;
            border: 1.5px solid #2d3748; background: #2d3748; color: #e2e8f0;
            font-family: 'Courier New', monospace; font-size: 0.78rem;
            transition: border-color 0.3s;
        }
        .config-field input:focus { border-color: #00d4aa; outline: none; }
        .config-field input.connected { border-color: #00b894; background: #1a3a2e; }
        .config-status { display: flex; align-items: center; gap: 8px; font-size: 0.82rem; }
        .config-status.ok { color: #00b894; }
        .config-status.err { color: #e17055; }
        .config-status.idle { color: #636e72; }

        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tab-nav { display: flex; gap: 4px; margin-bottom: 24px; }
        .tab-btn {
            flex: 1; padding: 12px 16px; border: none; border-radius: 10px;
            font-family: var(--font); font-size: 0.85rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s; background: #f1f2f6; color: var(--text-light);
        }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-btn .badge {
            display: inline-flex; align-items: center; justify-content: center;
            background: white; color: var(--primary); border-radius: 50%;
            width: 20px; height: 20px; font-size: 0.7rem; font-weight: 700;
            margin-left: 6px;
        }
        .tab-btn.active .badge { background: rgba(255,255,255,0.3); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ìˆ˜ì •ìš”ì²­ ì¹´ë“œ */
        .request-list { display: flex; flex-direction: column; gap: 12px; }
        .request-card {
            background: var(--card); border-radius: 14px; padding: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06); border-left: 4px solid var(--warning);
            transition: box-shadow 0.2s;
        }
        .request-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .request-card.approved { border-left-color: var(--success); opacity: 0.7; }
        .request-card.rejected { border-left-color: var(--danger); opacity: 0.7; }
        .request-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .request-store { font-size: 1rem; font-weight: 700; color: var(--text); }
        .request-date { font-size: 0.75rem; color: var(--text-light); }
        .request-field {
            display: inline-block; background: var(--primary-light); color: var(--primary-dark);
            padding: 2px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            margin-bottom: 10px;
        }
        .request-values {
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px;
            align-items: center; margin-bottom: 12px;
        }
        .val-box {
            padding: 8px 12px; border-radius: 8px; font-size: 0.82rem;
            word-break: break-all;
        }
        .val-old { background: #fff5f5; color: #c0392b; border: 1px solid #fad7d7; text-decoration: line-through; }
        .val-new { background: #f0fff4; color: #00b894; border: 1px solid #b2f5c8; font-weight: 600; }
        .val-arrow { text-align: center; font-size: 1.2rem; color: var(--text-light); }
        .request-reason { font-size: 0.78rem; color: var(--text-light); margin-bottom: 12px; font-style: italic; }
        .request-actions { display: flex; gap: 8px; justify-content: flex-end; }
        .status-badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d1e7dd; color: #0a3622; }
        .status-rejected { background: #f8d7da; color: #58151c; }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-light); }
        .empty-state i { font-size: 3rem; margin-bottom: 12px; opacity: 0.3; }
        .empty-state p { font-size: 0.9rem; }

        /* í•„í„° íƒ­ */
        .filter-tabs { display: flex; gap: 6px; margin-bottom: 16px; }
        .filter-tab {
            padding: 6px 16px; border-radius: 20px; border: 1.5px solid var(--border);
            background: white; font-family: var(--font); font-size: 0.8rem;
            cursor: pointer; transition: all 0.2s; font-weight: 500;
        }
        .filter-tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        @media (max-width: 768px) {
            .steps { flex-wrap: wrap; }
            .step { flex: none; width: calc(50% - 2px); }
            .mapping-grid { grid-template-columns: 1fr; }
            .stats-bar { grid-template-columns: repeat(2, 1fr); }
            .config-grid { grid-template-columns: 1fr; }
            .request-values { grid-template-columns: 1fr; }
            .val-arrow { display: none; }
            .tab-nav { flex-direction: column; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <h1><i class="fas fa-shield-alt"></i> í‚¤ì¦ˆê³  ê´€ë¦¬ì</h1>
        <a href="index.html"><i class="fas fa-arrow-left"></i> ë©”ì¸ìœ¼ë¡œ</a>
    </div>

    <div class="container">

        <!-- Supabase ì„¤ì • -->
        <div class="supabase-config" id="supabaseConfig">
            <div class="section-title"><i class="fas fa-plug"></i> Supabase ì—°ê²° ì„¤ì •</div>
            <div class="config-grid">
                <div class="config-field">
                    <label>PROJECT URL</label>
                    <input type="text" id="sbUrl" placeholder="https://xxxx.supabase.co" autocomplete="off">
                </div>
                <div class="config-field">
                    <label>ANON KEY</label>
                    <input type="password" id="sbKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." autocomplete="off">
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                <button class="btn btn-secondary" onclick="connectSupabase()">
                    <i class="fas fa-link"></i> ì—°ê²°í•˜ê¸°
                </button>
                <div class="config-status idle" id="configStatus">
                    <i class="fas fa-circle"></i> ì—°ê²° ì „
                </div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-nav" id="tabNav" style="display:none;">
            <button class="tab-btn active" onclick="switchTab('requests')" id="tabRequests">
                <i class="fas fa-edit"></i> ì •ë³´ìˆ˜ì • ìš”ì²­
                <span class="badge" id="pendingBadge">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('upload')" id="tabUpload">
                <i class="fas fa-upload"></i> CSV ë°ì´í„° ì—…ë¡œë“œ
            </button>
        </div>

        <!-- ìˆ˜ì •ìš”ì²­ íƒ­ -->
        <div class="tab-content active" id="tabContentRequests" style="display:none;">
            <div class="section">
                <div class="section-title"><i class="fas fa-inbox"></i> ì •ë³´ìˆ˜ì • ìš”ì²­ ëª©ë¡</div>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterRequests('pending')" id="ftPending">â³ ëŒ€ê¸°ì¤‘</button>
                    <button class="filter-tab" onclick="filterRequests('approved')" id="ftApproved">âœ… ìŠ¹ì¸ë¨</button>
                    <button class="filter-tab" onclick="filterRequests('rejected')" id="ftRejected">âŒ ê±°ì ˆë¨</button>
                    <button class="filter-tab" onclick="filterRequests('all')" id="ftAll">ì „ì²´</button>
                </div>
                <div class="request-list" id="requestList">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Supabaseì— ì—°ê²°í•˜ë©´ ìš”ì²­ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- CSV ì—…ë¡œë“œ íƒ­ -->
        <div class="tab-content" id="tabContentUpload">

        <!-- Stats -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-card">
                <div class="num" id="statTotal">-</div>
                <div class="label">í˜„ì¬ ë“±ë¡ ê°€ê²Œ</div>
            </div>
            <div class="stat-card">
                <div class="num" id="statCat">-</div>
                <div class="label">ì—…ì¢… ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="num" id="statRegion">-</div>
                <div class="label">ì§€ì—­ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="num" id="statAvgRating">-</div>
                <div class="label">í‰ê·  í‰ì </div>
            </div>
        </div>

        <!-- Steps -->
        <div class="steps">
            <div class="step active" id="step1"><span class="step-num">1</span> CSV íŒŒì¼ ì„ íƒ</div>
            <div class="step" id="step2"><span class="step-num">2</span> ë¯¸ë¦¬ë³´ê¸° í™•ì¸</div>
            <div class="step" id="step3"><span class="step-num">3</span> ì»¬ëŸ¼ ë§¤í•‘</div>
            <div class="step" id="step4"><span class="step-num">4</span> ì—…ë¡œë“œ</div>
        </div>

        <!-- Step 1: File Upload -->
        <div class="section" id="sectionUpload">
            <div class="section-title"><i class="fas fa-file-csv"></i> Step 1. CSV íŒŒì¼ ì„ íƒ</div>

            <div class="template-bar">
                <span><i class="fas fa-download"></i> ì˜¬ë°”ë¥¸ í˜•ì‹ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</span>
                <button class="btn btn-outline btn-sm" onclick="downloadTemplate()">
                    <i class="fas fa-file-download"></i> CSV í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <span>Python í¬ë¡¤ë§ ë“±ìœ¼ë¡œ ìˆ˜ì§‘í•œ ê°€ê²Œ ë°ì´í„°ë¥¼ CSV/ì—‘ì…€ë¡œ ì •ë¦¬í•œ í›„ ì—…ë¡œë“œí•˜ì„¸ìš”. ì»¬ëŸ¼ ì´ë¦„ì´ ë‹¬ë¼ë„ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë§¤í•‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
            </div>

            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</h3>
                <p>ì§€ì› í˜•ì‹: .csv, .tsv (UTF-8 ì¸ì½”ë”© ê¶Œì¥, ìµœëŒ€ 10MB)</p>
                <input type="file" id="fileInput" accept=".csv,.tsv,.txt">
            </div>
        </div>

        <!-- Step 2: Preview -->
        <div class="section hidden" id="sectionPreview">
            <div class="section-title"><i class="fas fa-table"></i> Step 2. ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</div>
            <div class="alert alert-info" id="previewAlert"></div>
            <div class="preview-wrapper">
                <table class="preview-table" id="previewTable">
                    <thead id="previewHead"></thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
            <div class="preview-info">
                <span id="previewCount"></span>
                <span>ì²˜ìŒ 20í–‰ë§Œ ë¯¸ë¦¬ë³´ê¸°ë¡œ í‘œì‹œë©ë‹ˆë‹¤</span>
            </div>
            <div class="actions-bar">
                <button class="btn btn-outline" onclick="goStep(1)"><i class="fas fa-arrow-left"></i> ë‹¤ì‹œ ì„ íƒ</button>
                <button class="btn btn-primary" onclick="goStep(3)">ì»¬ëŸ¼ ë§¤í•‘í•˜ê¸° <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- Step 3: Mapping -->
        <div class="section hidden" id="sectionMapping">
            <div class="section-title"><i class="fas fa-exchange-alt"></i> Step 3. ì»¬ëŸ¼ ë§¤í•‘</div>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>CSV ì»¬ëŸ¼ì„ í‚¤ì¦ˆê³  DB í•„ë“œì— ì—°ê²°í•˜ì„¸ìš”. <b>name(ê°€ê²Œì´ë¦„)</b>ì€ í•„ìˆ˜ì…ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ëŠ” ë¹„ì›Œë‘ë©´ ê¸°ë³¸ê°’ì´ ì ìš©ë©ë‹ˆë‹¤.</span>
            </div>
            <div class="mapping-grid" id="mappingGrid"></div>
            
            <div style="margin-top:20px; padding:16px; background:#f8f9fa; border-radius:12px;">
                <div class="section-title" style="margin-bottom:12px;"><i class="fas fa-cog"></i> ê¸°ì¡´ ë°ì´í„° ì²˜ë¦¬</div>
                <div class="existing-controls">
                    <div class="radio-group">
                        <label><input type="radio" name="existingData" value="keep" checked> ê¸°ì¡´ ë°ì´í„° ìœ ì§€ + ì¶”ê°€</label>
                        <label><input type="radio" name="existingData" value="clear"> ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ êµì²´</label>
                    </div>
                </div>
            </div>

            <div class="actions-bar">
                <button class="btn btn-outline" onclick="goStep(2)"><i class="fas fa-arrow-left"></i> ë¯¸ë¦¬ë³´ê¸°</button>
                <button class="btn btn-primary" id="btnStartUpload" onclick="startUpload()">
                    <i class="fas fa-upload"></i> ì—…ë¡œë“œ ì‹œì‘
                </button>
            </div>
        </div>

        <!-- Step 4: Upload Progress -->
        <div class="section hidden" id="sectionResult">
            <div class="section-title"><i class="fas fa-rocket"></i> Step 4. ì—…ë¡œë“œ ì§„í–‰</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-text" id="progressText">ì¤€ë¹„ ì¤‘...</div>
            <div class="result-log" id="resultLog"></div>
            <div class="actions-bar" id="resultActions" style="display:none;">
                <button class="btn btn-outline" onclick="location.reload()"><i class="fas fa-redo"></i> ìƒˆë¡œ ì—…ë¡œë“œ</button>
                <button class="btn btn-primary" onclick="location.href='index.html'"><i class="fas fa-home"></i> ë©”ì¸ì—ì„œ í™•ì¸</button>
            </div>
        </div>

        </div><!-- /tabContentUpload -->
    </div><!-- /container -->

<script>
// ===== Supabase í´ë¼ì´ì–¸íŠ¸ =====
let sb = null;
let allRequests = [];
let currentFilter = 'pending';

async function connectSupabase() {
    const url = document.getElementById('sbUrl').value.trim();
    const key = document.getElementById('sbKey').value.trim();
    const statusEl = document.getElementById('configStatus');

    if (!url || !key) {
        statusEl.className = 'config-status err';
        statusEl.innerHTML = '<i class="fas fa-times-circle"></i> URLê³¼ Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
    }

    statusEl.className = 'config-status idle';
    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì—°ê²° ì¤‘...';

    try {
        sb = supabase.createClient(url, key);
        // ì—°ê²° í…ŒìŠ¤íŠ¸
        const { error } = await sb.from('edit_requests').select('id').limit(1);
        if (error) throw error;

        statusEl.className = 'config-status ok';
        statusEl.innerHTML = '<i class="fas fa-check-circle"></i> ì—°ê²° ì„±ê³µ!';

        // ì…ë ¥ì°½ ì—°ê²°ë¨ í‘œì‹œ
        document.getElementById('sbUrl').classList.add('connected');
        document.getElementById('sbKey').classList.add('connected');

        // íƒ­ í‘œì‹œ ë° ìˆ˜ì •ìš”ì²­ íƒ­ í™œì„±í™”
        document.getElementById('tabNav').style.display = 'flex';
        document.getElementById('tabContentRequests').style.display = 'block';
        switchTab('requests');

        // ë°ì´í„° ë¡œë“œ
        await loadRequests();
        loadStats();

    } catch(e) {
        statusEl.className = 'config-status err';
        statusEl.innerHTML = `<i class="fas fa-times-circle"></i> ì—°ê²° ì‹¤íŒ¨: ${e.message}`;
        sb = null;
    }
}

// ===== íƒ­ ì „í™˜ =====
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    if (tab === 'requests') {
        document.getElementById('tabRequests').classList.add('active');
        document.getElementById('tabContentRequests').style.display = 'block';
        document.getElementById('tabContentRequests').classList.add('active');
        document.getElementById('tabContentUpload').style.display = 'none';
    } else {
        document.getElementById('tabUpload').classList.add('active');
        document.getElementById('tabContentUpload').style.display = 'block';
        document.getElementById('tabContentUpload').classList.add('active');
        document.getElementById('tabContentRequests').style.display = 'none';
    }
}

// ===== ìˆ˜ì •ìš”ì²­ ë¡œë“œ =====
async function loadRequests() {
    if (!sb) return;
    const { data, error } = await sb
        .from('edit_requests')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) { console.error(error); return; }
    allRequests = data || [];

    // pending ë°°ì§€ ì—…ë°ì´íŠ¸
    const pendingCount = allRequests.filter(r => r.status === 'pending').length;
    document.getElementById('pendingBadge').textContent = pendingCount;

    renderRequests();
}

// ===== í•„í„° =====
function filterRequests(status) {
    currentFilter = status;
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    const map = { pending: 'ftPending', approved: 'ftApproved', rejected: 'ftRejected', all: 'ftAll' };
    document.getElementById(map[status]).classList.add('active');
    renderRequests();
}

// ===== ìˆ˜ì •ìš”ì²­ ë Œë”ë§ =====
function renderRequests() {
    const list = document.getElementById('requestList');
    const filtered = currentFilter === 'all' ? allRequests : allRequests.filter(r => r.status === currentFilter);

    if (filtered.length === 0) {
        const msgs = { pending: 'ëŒ€ê¸° ì¤‘ì¸ ìˆ˜ì •ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.', approved: 'ìŠ¹ì¸ëœ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.', rejected: 'ê±°ì ˆëœ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.', all: 'ìˆ˜ì •ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.' };
        list.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>${msgs[currentFilter]}</p></div>`;
        return;
    }

    list.innerHTML = filtered.map(req => {
        const date = new Date(req.created_at).toLocaleString('ko-KR');
        const statusBadge = {
            pending: '<span class="status-badge status-pending">â³ ëŒ€ê¸°ì¤‘</span>',
            approved: '<span class="status-badge status-approved">âœ… ìŠ¹ì¸ë¨</span>',
            rejected: '<span class="status-badge status-rejected">âŒ ê±°ì ˆë¨</span>',
        }[req.status] || '';

        const actions = req.status === 'pending' ? `
            <button class="btn btn-sm btn-danger" onclick="rejectRequest(${req.id})">
                <i class="fas fa-times"></i> ê±°ì ˆ
            </button>
            <button class="btn btn-sm btn-secondary" onclick="approveRequest(${req.id}, '${escHtml(req.store_name)}', '${escHtml(req.field_name)}', '${escHtml(req.new_value)}')">
                <i class="fas fa-check"></i> ìŠ¹ì¸
            </button>
        ` : statusBadge;

        return `
        <div class="request-card ${req.status}" id="req-${req.id}">
            <div class="request-header">
                <div>
                    <div class="request-store">ğŸª ${escHtml(req.store_name)}</div>
                    <span class="request-field">${escHtml(req.field_name)}</span>
                </div>
                <div class="request-date">${date}</div>
            </div>
            <div class="request-values">
                <div class="val-box val-old">${escHtml(req.old_value || '(ì—†ìŒ)')}</div>
                <div class="val-arrow">â†’</div>
                <div class="val-box val-new">${escHtml(req.new_value)}</div>
            </div>
            ${req.reason ? `<div class="request-reason">ğŸ’¬ ì‚¬ìœ : ${escHtml(req.reason)}</div>` : ''}
            <div class="request-actions">${actions}</div>
        </div>`;
    }).join('');
}

function escHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ===== ìŠ¹ì¸ ì²˜ë¦¬ =====
async function approveRequest(id, storeName, fieldName, newValue) {
    if (!sb) return;
    if (!confirm(`"${storeName}"ì˜ ${fieldName} í•„ë“œë¥¼ "${newValue}"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        // 1. stores í…Œì´ë¸”ì—ì„œ ê°€ê²Œ ì°¾ê¸°
        const { data: stores, error: findErr } = await sb
            .from('stores')
            .select('id')
            .ilike('name', storeName)
            .limit(5);

        if (findErr) throw findErr;

        if (!stores || stores.length === 0) {
            alert(`âš ï¸ stores í…Œì´ë¸”ì—ì„œ "${storeName}"ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê°€ê²Œ ì´ë¦„ì´ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.`);
            return;
        }

        // ì—¬ëŸ¬ ê±´ì´ë©´ ì²« ë²ˆì§¸ ì‚¬ìš©
        const storeId = stores[0].id;

        // í•œê¸€ í•„ë“œëª… â†’ ì˜ë¬¸ ë³€í™˜
        const fieldNameMap = {
            'ì˜ì—…ì‹œê°„': 'hours',
            'ì „í™”ë²ˆí˜¸': 'phone',
            'ì£¼ì†Œ': 'address',
            'í‚¤ì¦ˆì¡´ì •ë³´': 'playroom_desc',
        };
        // ìë™ ë°˜ì˜ ë¶ˆê°€ í•­ëª©
        const manualFields = ['í¸ì˜ì‹œì„¤', 'íì—…', 'ê¸°íƒ€'];
        if (manualFields.includes(fieldName)) {
            alert(`"${fieldName}" í•­ëª©ì€ ë‚´ìš©ì„ ì§ì ‘ í™•ì¸ í›„ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.\n(ìë™ ë°˜ì˜ ë¶ˆê°€ í•­ëª©)`);
            // statusë§Œ approvedë¡œ ë³€ê²½
            const { error: statusErr2 } = await sb.from('edit_requests').update({ status: 'approved' }).eq('id', id);
            if (!statusErr2) {
                allRequests = allRequests.map(r => r.id === id ? {...r, status: 'approved'} : r);
                const pendingCount = allRequests.filter(r => r.status === 'pending').length;
                document.getElementById('pendingBadge').textContent = pendingCount;
                renderRequests();
                showToast('âœ… í™•ì¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (ìˆ˜ë™ ë°˜ì˜ í•„ìš”)');
            }
            return;
        }
        fieldName = fieldNameMap[fieldName] || fieldName;

        // boolean í•„ë“œ ë³€í™˜
        const boolFields = ['has_parking','has_nursing_room','has_highchair','has_stroller_access'];
        let parsedValue = newValue;
        if (boolFields.includes(fieldName)) {
            parsedValue = ['true','1','o','O','ì˜ˆ','Y','y','ìˆìŒ','ê°€ëŠ¥'].includes(newValue);
        } else if (['lat','lng','rating'].includes(fieldName)) {
            parsedValue = parseFloat(newValue);
        } else if (fieldName === 'review_count') {
            parsedValue = parseInt(newValue);
        }

        // 2. stores í…Œì´ë¸” ì—…ë°ì´íŠ¸
        const { error: updateErr } = await sb
            .from('stores')
            .update({ [fieldName]: parsedValue })
            .eq('id', storeId);

        if (updateErr) throw updateErr;

        // 3. edit_requests status â†’ approved
        const { error: statusErr } = await sb
            .from('edit_requests')
            .update({ status: 'approved' })
            .eq('id', id);

        if (statusErr) throw statusErr;

        // UI ì—…ë°ì´íŠ¸
        allRequests = allRequests.map(r => r.id === id ? {...r, status: 'approved'} : r);
        const pendingCount = allRequests.filter(r => r.status === 'pending').length;
        document.getElementById('pendingBadge').textContent = pendingCount;
        renderRequests();

        showToast('âœ… ìŠ¹ì¸ ì™„ë£Œ! stores í…Œì´ë¸”ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');

    } catch(e) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
        console.error(e);
    }
}

// ===== ê±°ì ˆ ì²˜ë¦¬ =====
async function rejectRequest(id) {
    if (!sb) return;
    if (!confirm('ì´ ìš”ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const { error } = await sb
            .from('edit_requests')
            .update({ status: 'rejected' })
            .eq('id', id);

        if (error) throw error;

        allRequests = allRequests.map(r => r.id === id ? {...r, status: 'rejected'} : r);
        const pendingCount = allRequests.filter(r => r.status === 'pending').length;
        document.getElementById('pendingBadge').textContent = pendingCount;
        renderRequests();

        showToast('âŒ ê±°ì ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch(e) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
    }
}

// ===== í† ìŠ¤íŠ¸ ì•Œë¦¼ =====
function showToast(msg) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position:fixed; bottom:24px; right:24px; z-index:9999;
        background:#2d3748; color:white; padding:14px 20px;
        border-radius:12px; font-size:0.85rem; font-weight:600;
        box-shadow:0 4px 20px rgba(0,0,0,0.2);
        animation: fadeIn 0.3s ease;
    `;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ===== State =====
let csvData = null;   // íŒŒì‹±ëœ ì „ì²´ ë°ì´í„° {headers:[], rows:[]}
let mapping = {};     // {dbField: csvColumn}

// DB í•„ë“œ ì •ì˜
const DB_FIELDS = [
    { key: 'name',               label: 'ê°€ê²Œ ì´ë¦„',     required: true },
    { key: 'category',           label: 'ì—…ì¢…(ëŒ€ë¶„ë¥˜)',   required: false, hint: 'ì‹ë‹¹/ì¹´í˜/í‚¤ì¦ˆì¹´í˜/ë·”í˜/ë² ì´ì»¤ë¦¬' },
    { key: 'subcategory',        label: 'ì„¸ë¶€ì—…ì¢…',       required: false, hint: 'í•œì‹/ì–‘ì‹/ê³ ê¸°ì§‘/íšŸì§‘ ë“±' },
    { key: 'region',             label: 'ì§€ì—­(ì‹œ/ë„)',    required: false, hint: 'ì„œìš¸/ê²½ê¸°/ë¶€ì‚° ë“±' },
    { key: 'district',           label: 'êµ¬/êµ°',          required: false },
    { key: 'address',            label: 'ìƒì„¸ì£¼ì†Œ',       required: false },
    { key: 'lat',                label: 'ìœ„ë„',           required: false },
    { key: 'lng',                label: 'ê²½ë„',           required: false },
    { key: 'phone',              label: 'ì „í™”ë²ˆí˜¸',       required: false },
    { key: 'hours',              label: 'ì˜ì—…ì‹œê°„',       required: false },
    { key: 'playroom_type',      label: 'ë†€ì´ë°© ìœ í˜•',    required: false, hint: 'ì‹¤ë‚´ë†€ì´ë°©/í‚¤ì¦ˆì¡´/ë³¼í’€ ë“±' },
    { key: 'playroom_desc',      label: 'ë†€ì´ë°© ì„¤ëª…',    required: false },
    { key: 'age_range',          label: 'ê¶Œì¥ ì—°ë ¹',      required: false, hint: '0~3ì„¸/3~5ì„¸/ì „ì—°ë ¹ ë“±' },
    { key: 'has_parking',        label: 'ì£¼ì°¨ ì—¬ë¶€',      required: false, hint: 'true/false ë˜ëŠ” O/X' },
    { key: 'has_nursing_room',   label: 'ìˆ˜ìœ ì‹¤ ì—¬ë¶€',    required: false },
    { key: 'has_highchair',      label: 'ìœ ì•„ì˜ì ì—¬ë¶€',  required: false },
    { key: 'has_stroller_access',label: 'ìœ ëª¨ì°¨ ì ‘ê·¼',    required: false },
    { key: 'price_range',        label: 'ê°€ê²©ëŒ€',         required: false, hint: '$/$$/$$$ ë˜ëŠ” ì €ë ´/ë³´í†µ/ê³ ê¸‰' },
    { key: 'rating',             label: 'í‰ì ',           required: false, hint: '1~5 ìˆ«ì' },
    { key: 'review_count',       label: 'ë¦¬ë·° ìˆ˜',       required: false },
    { key: 'tags',               label: 'íƒœê·¸',           required: false, hint: 'ì‰¼í‘œ êµ¬ë¶„: ìƒì¼íŒŒí‹°,ëŒì”ì¹˜' },
    { key: 'description',        label: 'ê°€ê²Œ ì†Œê°œ',      required: false },
];

// ===== Init =====
document.addEventListener('DOMContentLoaded', () => {
    // CSV ì—…ë¡œë“œ íƒ­ì€ ì—°ê²° í›„ í‘œì‹œ
    document.getElementById('tabContentUpload').style.display = 'none';
    setupDragDrop();
    document.getElementById('fileInput').addEventListener('change', handleFile);
});

// ===== Stats =====
async function loadStats() {
    try {
        const r = await fetch('tables/stores?limit=1');
        const res = await r.json();
        const total = res.total || 0;
        document.getElementById('statTotal').textContent = total.toLocaleString();
        
        if (total > 0) {
            // ì „ì²´ ë°ì´í„° ê°„ë‹¨ í†µê³„
            let allData = [];
            const pages = Math.ceil(Math.min(total, 500) / 100);
            for (let p = 1; p <= pages; p++) {
                const pr = await fetch(`tables/stores?page=${p}&limit=100`);
                const pres = await pr.json();
                allData = allData.concat(pres.data || []);
            }
            const cats = new Set(allData.map(d => d.category).filter(Boolean));
            const regions = new Set(allData.map(d => d.region).filter(Boolean));
            const avgRating = allData.reduce((s,d) => s + (d.rating||0), 0) / allData.length;
            
            document.getElementById('statCat').textContent = cats.size;
            document.getElementById('statRegion').textContent = regions.size;
            document.getElementById('statAvgRating').textContent = avgRating.toFixed(1);
        }
    } catch(e) {
        console.error('Stats load error:', e);
    }
}

// ===== Drag & Drop =====
function setupDragDrop() {
    const zone = document.getElementById('uploadZone');
    ['dragenter','dragover'].forEach(e => {
        zone.addEventListener(e, (ev) => { ev.preventDefault(); zone.classList.add('dragover'); });
    });
    ['dragleave','drop'].forEach(e => {
        zone.addEventListener(e, (ev) => { ev.preventDefault(); zone.classList.remove('dragover'); });
    });
    zone.addEventListener('drop', (ev) => {
        const file = ev.dataTransfer.files[0];
        if (file) processFile(file);
    });
}

// ===== File Handling =====
function handleFile(e) {
    const file = e.target.files[0];
    if (file) processFile(file);
}

function processFile(file) {
    if (file.size > 10 * 1024 * 1024) {
        alert('íŒŒì¼ì´ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.');
        return;
    }
    
    const zone = document.getElementById('uploadZone');
    zone.innerHTML = `
        <i class="fas fa-spinner fa-spin" style="color:var(--primary);"></i>
        <h3>íŒŒì¼ ë¶„ì„ ì¤‘...</h3>
        <p>${file.name} (${(file.size/1024).toFixed(1)}KB)</p>
    `;

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        encoding: 'UTF-8',
        complete: function(results) {
            if (results.errors.length > 0 && results.data.length === 0) {
                alert('CSV íŒŒì‹± ì˜¤ë¥˜: ' + results.errors[0].message);
                location.reload();
                return;
            }
            csvData = {
                headers: results.meta.fields || [],
                rows: results.data,
                fileName: file.name
            };
            renderPreview();
            goStep(2);
        },
        error: function(err) {
            alert('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + err.message);
            location.reload();
        }
    });
}

// ===== Preview =====
function renderPreview() {
    if (!csvData) return;
    const { headers, rows } = csvData;

    document.getElementById('previewAlert').innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span><b>${csvData.fileName}</b> Â· ì»¬ëŸ¼ ${headers.length}ê°œ Â· ë°ì´í„° <b>${rows.length}í–‰</b> ê°ì§€</span>
    `;
    document.getElementById('previewAlert').className = 'alert alert-success';

    // Header
    const headHtml = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
    document.getElementById('previewHead').innerHTML = headHtml;

    // Body (max 20 rows)
    const previewRows = rows.slice(0, 20);
    const bodyHtml = previewRows.map(row =>
        '<tr>' + headers.map(h => `<td title="${row[h] || ''}">${row[h] || ''}</td>`).join('') + '</tr>'
    ).join('');
    document.getElementById('previewBody').innerHTML = bodyHtml;
    document.getElementById('previewCount').textContent = `${rows.length}í–‰ ì¤‘ ${previewRows.length}í–‰ í‘œì‹œ`;
}

// ===== Mapping =====
function renderMapping() {
    if (!csvData) return;
    const { headers } = csvData;
    const grid = document.getElementById('mappingGrid');

    grid.innerHTML = DB_FIELDS.map(field => {
        const options = headers.map(h => `<option value="${h}" ${autoMatch(field.key, h) ? 'selected' : ''}>${h}</option>`);
        const hintHtml = field.hint ? `<br><small style="color:#94a3b8;font-size:0.7rem;">${field.hint}</small>` : '';
        const reqHtml = field.required ? '<span class="field-required">*í•„ìˆ˜</span>' : '';
        
        return `
            <div class="mapping-item">
                <div class="field-name">${field.label} ${reqHtml}${hintHtml}</div>
                <i class="fas fa-arrow-right"></i>
                <select data-field="${field.key}" onchange="updateMappingState()">
                    <option value="">-- ë§¤í•‘ ì•ˆ í•¨ --</option>
                    ${options.join('')}
                </select>
            </div>
        `;
    }).join('');

    // ìë™ ë§¤í•‘ ì ìš©
    updateMappingState();
}

function autoMatch(dbField, csvCol) {
    const col = csvCol.toLowerCase().replace(/[\s_-]/g, '');
    const db = dbField.toLowerCase().replace(/[\s_-]/g, '');
    
    // ì •í™• ë§¤ì¹˜
    if (col === db) return true;
    
    // í•œê¸€ ë§¤ì¹­
    const koreanMap = {
        name: ['ê°€ê²Œì´ë¦„','ì´ë¦„','ìƒí˜¸','ìƒí˜¸ëª…','ê°€ê²Œëª…','ë§¤ì¥ëª…','ì—…ì†Œëª…','ì í¬ëª…'],
        category: ['ì—…ì¢…','ëŒ€ë¶„ë¥˜','ì¹´í…Œê³ ë¦¬','ë¶„ë¥˜'],
        subcategory: ['ì„¸ë¶€ì—…ì¢…','ì†Œë¶„ë¥˜','ì„¸ë¶€ë¶„ë¥˜','ì„œë¸Œì¹´í…Œê³ ë¦¬'],
        region: ['ì§€ì—­','ì‹œë„','ì‹œ','ë„','ê´‘ì—­ì‹œ'],
        district: ['êµ¬','êµ°','êµ¬êµ°','ì‹œêµ°êµ¬'],
        address: ['ì£¼ì†Œ','ìƒì„¸ì£¼ì†Œ','ë„ë¡œëª…ì£¼ì†Œ','ì§€ë²ˆì£¼ì†Œ'],
        lat: ['ìœ„ë„','latitude','y'],
        lng: ['ê²½ë„','longitude','x','lon'],
        phone: ['ì „í™”','ì „í™”ë²ˆí˜¸','ì—°ë½ì²˜','tel'],
        hours: ['ì˜ì—…ì‹œê°„','ìš´ì˜ì‹œê°„','ì‹œê°„'],
        playroom_type: ['ë†€ì´ë°©ìœ í˜•','ë†€ì´ì‹œì„¤','ë†€ì´ë°©ì¢…ë¥˜','í‚¤ì¦ˆì¡´ìœ í˜•'],
        playroom_desc: ['ë†€ì´ë°©ì„¤ëª…','ë†€ì´ì‹œì„¤ì„¤ëª…','í‚¤ì¦ˆì¡´ì„¤ëª…'],
        age_range: ['ì—°ë ¹','ì—°ë ¹ëŒ€','ê¶Œì¥ì—°ë ¹','ë‚˜ì´'],
        has_parking: ['ì£¼ì°¨','ì£¼ì°¨ê°€ëŠ¥','ì£¼ì°¨ì—¬ë¶€'],
        has_nursing_room: ['ìˆ˜ìœ ì‹¤','ìˆ˜ìœ ì‹¤ì—¬ë¶€'],
        has_highchair: ['ìœ ì•„ì˜ì','ì•„ê¸°ì˜ì','í•˜ì´ì²´ì–´'],
        has_stroller_access: ['ìœ ëª¨ì°¨','ìœ ëª¨ì°¨ì ‘ê·¼','ìœ ëª¨ì°¨ê°€ëŠ¥'],
        price_range: ['ê°€ê²©ëŒ€','ê°€ê²©','ê°€ê²©ë²”ìœ„','ê°€ê²©ìˆ˜ì¤€'],
        rating: ['í‰ì ','ë³„ì ','ì ìˆ˜','rating'],
        review_count: ['ë¦¬ë·°ìˆ˜','ë¦¬ë·°','í›„ê¸°ìˆ˜','review'],
        tags: ['íƒœê·¸','í‚¤ì›Œë“œ','í•´ì‹œíƒœê·¸'],
        description: ['ì„¤ëª…','ì†Œê°œ','ê°€ê²Œì†Œê°œ','ìƒì„¸ì„¤ëª…','ë©”ëª¨'],
    };
    
    const aliases = koreanMap[dbField] || [];
    return aliases.some(a => col.includes(a.replace(/[\s_-]/g, '')));
}

function updateMappingState() {
    mapping = {};
    document.querySelectorAll('#mappingGrid select').forEach(sel => {
        const field = sel.dataset.field;
        const val = sel.value;
        if (val) {
            mapping[field] = val;
            sel.className = 'mapped';
        } else {
            sel.className = val === '' ? 'unmapped' : '';
        }
    });
}

// ===== Step Navigation =====
function goStep(n) {
    ['sectionUpload','sectionPreview','sectionMapping','sectionResult'].forEach((id,i) => {
        document.getElementById(id).classList.toggle('hidden', i !== n-1);
    });
    for (let i = 1; i <= 4; i++) {
        const el = document.getElementById('step'+i);
        el.classList.remove('active','done');
        if (i < n) el.classList.add('done');
        if (i === n) el.classList.add('active');
    }
    if (n === 3) renderMapping();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===== Upload =====
async function startUpload() {
    if (!mapping.name) {
        alert('ê°€ê²Œ ì´ë¦„(name) ë§¤í•‘ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!');
        return;
    }
    if (!csvData || csvData.rows.length === 0) {
        alert('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const confirmMsg = `ì´ ${csvData.rows.length}ê±´ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    if (!confirm(confirmMsg)) return;

    goStep(4);
    const log = document.getElementById('resultLog');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    log.innerHTML = '';

    function addLog(msg, type='info') {
        log.innerHTML += `<div class="${type}">  ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    // ê¸°ì¡´ ë°ì´í„° ì²˜ë¦¬
    const existingAction = document.querySelector('input[name="existingData"]:checked').value;
    if (existingAction === 'clear') {
        addLog('âš ï¸ ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì‹œì‘...', 'warn');
        try {
            while (true) {
                const r = await fetch('tables/stores?page=1&limit=100');
                const res = await r.json();
                const data = res.data || [];
                if (data.length === 0) break;
                await Promise.all(data.map(d => fetch(`tables/stores/${d.id}`, { method: 'DELETE' })));
                addLog(`  ğŸ—‘ï¸ ${data.length}ê±´ ì‚­ì œ`, 'warn');
            }
            addLog('âœ… ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ', 'success');
        } catch(e) {
            addLog('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + e.message, 'error');
        }
    }

    // ë°ì´í„° ë³€í™˜
    addLog(`ğŸ“‹ ${csvData.rows.length}ê±´ ë³€í™˜ ì‹œì‘...`, 'info');
    const records = [];
    let skipCount = 0;

    csvData.rows.forEach((row, i) => {
        const record = {};
        
        // ë§¤í•‘ ì ìš©
        DB_FIELDS.forEach(field => {
            const csvCol = mapping[field.key];
            if (csvCol && row[csvCol] !== undefined && row[csvCol] !== '') {
                let val = String(row[csvCol]).trim();
                
                // íƒ€ì… ë³€í™˜
                if (['lat','lng','rating'].includes(field.key)) {
                    val = parseFloat(val) || 0;
                } else if (field.key === 'review_count') {
                    val = parseInt(val) || 0;
                } else if (['has_parking','has_nursing_room','has_highchair','has_stroller_access'].includes(field.key)) {
                    val = ['true','1','o','O','ì˜ˆ','Y','y','ìˆìŒ','ê°€ëŠ¥'].includes(val);
                } else if (field.key === 'tags') {
                    val = val.split(/[,;|]/).map(t => t.trim()).filter(Boolean);
                } else if (field.key === 'price_range') {
                    if (['ì €ë ´','ì‹¸ë‹¤','ë‚®ìŒ','low'].includes(val.toLowerCase())) val = '$';
                    else if (['ë³´í†µ','ì¤‘ê°„','medium','mid'].includes(val.toLowerCase())) val = '$$';
                    else if (['ê³ ê¸‰','ë¹„ìŒˆ','ë†’ìŒ','high','í”„ë¦¬ë¯¸ì—„'].includes(val.toLowerCase())) val = '$$$';
                }
                
                record[field.key] = val;
            }
        });

        // í•„ìˆ˜ í•„ë“œ ì²´í¬
        if (!record.name) {
            skipCount++;
            return;
        }

        // ê¸°ë³¸ê°’ ì ìš©
        if (!record.category) record.category = 'ì‹ë‹¹';
        if (!record.subcategory) record.subcategory = 'í•œì‹';
        if (!record.region) {
            // ì£¼ì†Œì—ì„œ ì§€ì—­ ì¶”ì¶œ ì‹œë„
            const addr = record.address || '';
            const regions = ['ì„œìš¸','ê²½ê¸°','ì¸ì²œ','ë¶€ì‚°','ëŒ€êµ¬','ëŒ€ì „','ê´‘ì£¼','ìš¸ì‚°','ê²½ë‚¨','ì¶©ë¶','ì¶©ë‚¨','ê°•ì›','ì œì£¼'];
            record.region = regions.find(r => addr.includes(r)) || 'ì„œìš¸';
        }
        if (!record.playroom_type) record.playroom_type = 'í‚¤ì¦ˆì¡´';
        if (!record.age_range) record.age_range = 'ì „ì—°ë ¹';
        if (!record.price_range) record.price_range = '$$';
        if (!record.rating) record.rating = +(3.5 + Math.random() * 1.5).toFixed(1);
        if (!record.review_count) record.review_count = Math.floor(10 + Math.random() * 200);
        if (!record.tags || record.tags.length === 0) record.tags = ['ê°€ì¡±ì™¸ì‹', 'ì•„ì´'];
        if (!record.description) record.description = record.playroom_desc || 'í‚¤ì¦ˆí”„ë Œë“¤ë¦¬ ê°€ê²Œì…ë‹ˆë‹¤.';

        records.push(record);
    });

    addLog(`âœ… ë³€í™˜ ì™„ë£Œ: ${records.length}ê±´ (ìŠ¤í‚µ: ${skipCount}ê±´)`, 'success');

    // ì—…ë¡œë“œ
    if (records.length === 0) {
        addLog('âŒ ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
        document.getElementById('resultActions').style.display = 'flex';
        return;
    }

    addLog(`ğŸš€ API ì—…ë¡œë“œ ì‹œì‘ (${records.length}ê±´)...`, 'info');
    const batchSize = 20;
    let uploaded = 0;
    let errors = 0;

    for (let i = 0; i < records.length; i += batchSize) {
        const batch = records.slice(i, i + batchSize);
        const results = await Promise.allSettled(
            batch.map(rec =>
                fetch('tables/stores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rec)
                })
            )
        );

        results.forEach((r, j) => {
            if (r.status === 'fulfilled' && r.value.ok) {
                uploaded++;
            } else {
                errors++;
                addLog(`  âš ï¸ [${i+j+1}] ${batch[j].name} ì‹¤íŒ¨`, 'error');
            }
        });

        const pct = Math.round(((i + batch.length) / records.length) * 100);
        progressFill.style.width = pct + '%';
        progressText.textContent = `${uploaded}/${records.length} ì—…ë¡œë“œ ì™„ë£Œ (${pct}%)`;
        
        if ((i + batch.length) % 100 === 0 || i + batch.length >= records.length) {
            addLog(`  ğŸ“¦ ${uploaded}ê±´ ì™„ë£Œ...`, 'info');
        }
    }

    // ì™„ë£Œ
    progressFill.style.width = '100%';
    addLog('', 'info');
    addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    addLog(`ğŸ‰ ì—…ë¡œë“œ ì™„ë£Œ!`, 'success');
    addLog(`   âœ… ì„±ê³µ: ${uploaded}ê±´`, 'success');
    if (errors > 0) addLog(`   âŒ ì‹¤íŒ¨: ${errors}ê±´`, 'error');
    if (skipCount > 0) addLog(`   â­ï¸ ìŠ¤í‚µ: ${skipCount}ê±´ (ì´ë¦„ ì—†ìŒ)`, 'warn');
    addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    progressText.textContent = `ì™„ë£Œ! ${uploaded}ê±´ ì—…ë¡œë“œ ì„±ê³µ`;
    document.getElementById('resultActions').style.display = 'flex';
}

// ===== Template Download =====
function downloadTemplate() {
    const headers = DB_FIELDS.map(f => f.key);
    const example = {
        name: 'ë§›ìˆëŠ” ê³ ê¸°ì§‘',
        category: 'ì‹ë‹¹',
        subcategory: 'ê³ ê¸°ì§‘',
        region: 'ì„œìš¸',
        district: 'ê°•ë‚¨êµ¬',
        address: 'ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123',
        lat: '37.498',
        lng: '127.028',
        phone: '02-123-4567',
        hours: '11:00~22:00 (ì›” íœ´ë¬´)',
        playroom_type: 'ì‹¤ë‚´ë†€ì´ë°©',
        playroom_desc: 'ë³¼í’€+ë¯¸ë„ëŸ¼í‹€ í‚¤ì¦ˆì¡´ ìš´ì˜. CCTV ì™„ë¹„',
        age_range: 'ì „ì—°ë ¹',
        has_parking: 'O',
        has_nursing_room: 'O',
        has_highchair: 'O',
        has_stroller_access: 'O',
        price_range: '$$',
        rating: '4.3',
        review_count: '150',
        tags: 'í•œìš°,ìˆ¯ë¶ˆêµ¬ì´,ìƒì¼íŒŒí‹°',
        description: 'í”„ë¦¬ë¯¸ì—„ í•œìš° ì „ë¬¸ì . ë„“ì€ í‚¤ì¦ˆë£¸ì— CCTV ëª¨ë‹ˆí„°ë§ ì™„ë¹„'
    };
    
    const csv = headers.join(',') + '\n' + headers.map(h => `"${example[h] || ''}"`).join(',') + '\n';
    const bom = '\uFEFF';
    const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'kidsgo_template.csv';
    a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>